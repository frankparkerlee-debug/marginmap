<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - MarginMap</title>
  <link rel="stylesheet" href="/css/app.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">
        <span class="logo-icon">üìä</span>
        <span class="logo-text">MarginMap</span>
      </div>

      <nav class="nav">
        <a href="/dashboard.html" class="nav-link active">
          <span class="nav-icon">üìà</span>
          <span>Dashboard</span>
        </a>
        <a href="/sku.html" class="nav-link">
          <span class="nav-icon">üì¶</span>
          <span>SKU Explorer</span>
        </a>
        <a href="/customers.html" class="nav-link">
          <span class="nav-icon">üë•</span>
          <span>Customers</span>
        </a>
        <a href="/actions.html" class="nav-link">
          <span class="nav-icon">‚ö°</span>
          <span>AI Actions</span>
        </a>
        <a href="/upload.html" class="nav-link">
          <span class="nav-icon">‚¨ÜÔ∏è</span>
          <span>Upload Data</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <button id="logout-btn" class="logout-btn">
          <span>üö™</span> Logout
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="page-header">
        <div>
          <h1>Profit Dashboard</h1>
          <p class="page-subtitle">Real-time margin intelligence and performance metrics</p>
        </div>
        <div id="business-type-indicator">
          <!-- Dynamic business type will be inserted here -->
        </div>
      </header>

      <!-- KPI Cards -->
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-icon">üí∞</span>
            <span class="metric-label">Total Revenue</span>
          </div>
          <div class="metric-value" id="total-revenue">$0</div>
          <div class="metric-change positive" id="revenue-change"></div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-icon">üìä</span>
            <span class="metric-label">Gross Margin</span>
          </div>
          <div class="metric-value" id="gross-margin">0%</div>
          <div class="metric-subvalue" id="gross-profit">$0 profit</div>
        </div>

        <div class="metric-card highlight-card">
          <div class="metric-header">
            <span class="metric-icon">üéØ</span>
            <span class="metric-label">Net Margin</span>
          </div>
          <div class="metric-value" id="net-margin">0%</div>
          <div class="metric-subvalue" id="net-profit">$0 profit</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-icon">üí∏</span>
            <span class="metric-label">Total Expenses</span>
          </div>
          <div class="metric-value" id="total-expenses">$0</div>
          <div class="metric-subvalue" id="expenses-percent">0% of revenue</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-icon">üì¶</span>
            <span class="metric-label">COGS</span>
          </div>
          <div class="metric-value" id="total-cogs">$0</div>
          <div class="metric-subvalue" id="cogs-percent">0% of revenue</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-icon">üíß</span>
            <span class="metric-label">Margin Leakage</span>
          </div>
          <div class="metric-value warning" id="total-leakage">$0</div>
          <div class="metric-subvalue" id="leakage-percent">0% of revenue</div>
        </div>
      </div>

      <!-- Expense Breakdown -->
      <div class="card" id="expense-breakdown-card" style="display: none;">
        <div class="card-header">
          <h2>Expense Breakdown</h2>
          <span class="card-subtitle">Operating expenses by category</span>
        </div>
        <div class="card-body">
          <div id="expense-breakdown" class="expense-grid"></div>
        </div>
      </div>

      <!-- Charts and Tables Row -->
      <div class="dashboard-grid">
        <!-- Margin Trend Chart -->
        <div class="card chart-card">
          <div class="card-header">
            <h2>Margin % Trend</h2>
            <span class="card-subtitle">Daily gross margin performance</span>
          </div>
          <div class="card-body">
            <canvas id="margin-chart"></canvas>
          </div>
        </div>

        <!-- Top Low Margin SKUs -->
        <div class="card">
          <div class="card-header">
            <h2>Low Margin SKUs</h2>
            <span class="card-subtitle">Products below target margin</span>
          </div>
          <div class="card-body">
            <div id="low-margin-skus" class="data-list"></div>
          </div>
        </div>

        <!-- Top Low Margin Customers -->
        <div class="card">
          <div class="card-header">
            <h2>Low Margin Customers</h2>
            <span class="card-subtitle">Accounts with margin erosion</span>
          </div>
          <div class="card-body">
            <div id="low-margin-customers" class="data-list"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div id="toast-container"></div>

  <script type="module">
    import { formatCurrency, formatPercent, apiCall, initNavigation, showToast, checkAuth, animateNumber } from '/js/common.js';

    let marginChart = null;

    async function loadDashboard() {
      try {
        await checkAuth();

        const data = await apiCall('/api/dashboard');

        // Display business type indicator
        if (data.businessType) {
          const indicator = document.getElementById('business-type-indicator');
          indicator.innerHTML = `<span class="badge badge-low">${data.businessType.charAt(0).toUpperCase() + data.businessType.slice(1)} Mode</span>`;
        }

        // Update KPIs with basic metrics
        const revenueEl = document.getElementById('total-revenue');
        const grossMarginEl = document.getElementById('gross-margin');
        const leakageEl = document.getElementById('total-leakage');
        const cogsEl = document.getElementById('total-cogs');

        revenueEl.textContent = formatCurrency(data.overview.revenue);
        grossMarginEl.textContent = formatPercent(data.overview.grossMarginPercent);
        leakageEl.textContent = formatCurrency(data.leakage.totalLeakage);
        cogsEl.textContent = formatCurrency(data.overview.cogs);

        document.getElementById('gross-profit').textContent = formatCurrency(data.overview.grossProfit) + ' profit';
        document.getElementById('leakage-percent').textContent = formatPercent(data.leakage.leakagePercent) + ' of potential revenue';

        const cogsPercent = data.overview.revenue > 0 ? (data.overview.cogs / data.overview.revenue) * 100 : 0;
        document.getElementById('cogs-percent').textContent = formatPercent(cogsPercent) + ' of revenue';

        // Update enhanced metrics if available
        if (data.enhancedOverview) {
          const netMarginEl = document.getElementById('net-margin');
          const netProfitEl = document.getElementById('net-profit');
          const expensesEl = document.getElementById('total-expenses');
          const expensesPercentEl = document.getElementById('expenses-percent');

          netMarginEl.textContent = formatPercent(data.enhancedOverview.netMarginPercent);
          netProfitEl.textContent = formatCurrency(data.enhancedOverview.netProfit) + ' profit';
          expensesEl.textContent = formatCurrency(data.enhancedOverview.totalExpenses);

          const expensesPercent = data.enhancedOverview.revenue > 0
            ? (data.enhancedOverview.totalExpenses / data.enhancedOverview.revenue) * 100
            : 0;
          expensesPercentEl.textContent = formatPercent(expensesPercent) + ' of revenue';

          // Render expense breakdown if available
          if (data.expenseBreakdown && Object.keys(data.expenseBreakdown).length > 0) {
            renderExpenseBreakdown(data.expenseBreakdown);
            document.getElementById('expense-breakdown-card').style.display = 'block';
          }
        }

        // Render margin trend chart
        renderMarginChart(data.marginTrend);

        // Render low margin SKUs
        renderLowMarginSkus(data.topLowMarginSkus);

        // Render low margin customers
        renderLowMarginCustomers(data.topLowMarginCustomers);

      } catch (error) {
        console.error('Dashboard load failed:', error);
        showToast('Failed to load dashboard data', 'error');
      }
    }

    function renderMarginChart(trendData) {
      const ctx = document.getElementById('margin-chart');

      if (marginChart) {
        marginChart.destroy();
      }

      const labels = trendData.map(d => {
        const date = new Date(d.date);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });

      const margins = trendData.map(d => d.marginPercent);

      marginChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Gross Margin %',
            data: margins,
            borderColor: '#0ea5e9',
            backgroundColor: 'rgba(14, 165, 233, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#0ea5e9',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: '#1a1a2e',
              padding: 12,
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#0ea5e9',
              borderWidth: 1,
              displayColors: false,
              callbacks: {
                label: (context) => `Margin: ${context.parsed.y.toFixed(1)}%`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              ticks: {
                callback: (value) => value.toFixed(0) + '%',
                color: '#64748b'
              },
              grid: {
                color: '#f1f5f9'
              }
            },
            x: {
              ticks: {
                color: '#64748b'
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    function renderLowMarginSkus(skus) {
      const container = document.getElementById('low-margin-skus');

      if (!skus || skus.length === 0) {
        container.innerHTML = '<div class="empty-state">No low-margin SKUs found</div>';
        return;
      }

      container.innerHTML = skus.map(sku => `
        <div class="list-item">
          <div class="list-item-main">
            <div class="list-item-title">${sku.skuName}</div>
            <div class="list-item-subtitle">${sku.skuCode}</div>
          </div>
          <div class="list-item-side">
            <div class="list-item-value ${getMarginClass(sku.marginPercent)}">
              ${formatPercent(sku.marginPercent)}
            </div>
            <div class="list-item-subtitle">${formatCurrency(sku.revenue)}</div>
          </div>
        </div>
      `).join('');
    }

    function renderLowMarginCustomers(customers) {
      const container = document.getElementById('low-margin-customers');

      if (!customers || customers.length === 0) {
        container.innerHTML = '<div class="empty-state">No low-margin customers found</div>';
        return;
      }

      container.innerHTML = customers.map(customer => `
        <div class="list-item">
          <div class="list-item-main">
            <div class="list-item-title">${customer.customerName}</div>
            <div class="list-item-subtitle">Revenue: ${formatCurrency(customer.revenue)}</div>
          </div>
          <div class="list-item-side">
            <div class="list-item-value ${getMarginClass(customer.marginPercent)}">
              ${formatPercent(customer.marginPercent)}
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderExpenseBreakdown(expenseBreakdown) {
      const container = document.getElementById('expense-breakdown');

      const expenses = Object.entries(expenseBreakdown)
        .sort((a, b) => b[1].total - a[1].total)
        .slice(0, 6); // Top 6 expense categories

      container.innerHTML = expenses.map(([code, expense]) => `
        <div class="expense-item">
          <div class="expense-label">${expense.name}</div>
          <div class="expense-value">${formatCurrency(expense.total)}</div>
        </div>
      `).join('');
    }

    function getMarginClass(margin) {
      if (margin >= 55) return 'good';
      if (margin >= 45) return 'warning';
      return 'critical';
    }

    // Initialize
    initNavigation();
    loadDashboard();
  </script>

  <style>
    #margin-chart {
      height: 280px;
    }

    .chart-card {
      grid-column: 1 / -1;
    }

    .highlight-card {
      background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
      color: white;
      box-shadow: 0 4px 20px rgba(14, 165, 233, 0.3);
    }

    .highlight-card .metric-icon {
      font-size: 28px;
    }

    .highlight-card .metric-label {
      color: rgba(255, 255, 255, 0.9);
    }

    .highlight-card .metric-value {
      color: white;
      font-size: 36px;
    }

    .highlight-card .metric-subvalue {
      color: rgba(255, 255, 255, 0.8);
    }

    .expense-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .expense-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 16px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 3px solid #0ea5e9;
    }

    .expense-label {
      font-size: 13px;
      color: #64748b;
      font-weight: 500;
    }

    .expense-value {
      font-size: 18px;
      font-weight: 700;
      color: #1a1a2e;
    }

    .data-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .list-item:hover {
      background: #f1f5f9;
      transform: translateX(4px);
    }

    .list-item-main {
      flex: 1;
    }

    .list-item-title {
      font-weight: 600;
      color: #1a1a2e;
      margin-bottom: 2px;
    }

    .list-item-subtitle {
      font-size: 13px;
      color: #64748b;
    }

    .list-item-side {
      text-align: right;
    }

    .list-item-value {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 2px;
    }

    .list-item-value.good {
      color: #10b981;
    }

    .list-item-value.warning {
      color: #f59e0b;
    }

    .list-item-value.critical {
      color: #ef4444;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #94a3b8;
    }
  </style>
</body>
</html>
